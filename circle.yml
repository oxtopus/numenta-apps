general:
  branches:
    only:
      - DEVOPS-53-circleci
machine:
  environment:
    PATH: $PATH:/home/ubuntu/local/bin
    PYTHONPATH: /home/ubuntu/local/lib/python2.7/site-packages
    CC: clang
    CXX: clang++
    APPLICATION_CONFIG_PATH: /home/ubuntu/numenta-apps/taurus/conf
    RABBITMQ_HOST: localhost
    RABBITMQ_USER: guest
    RABBITMQ_PASSWD: guest
    MYSQL_HOST: localhost
    MYSQL_USER: ubuntu
dependencies:
  cache_directories:
    - capnproto-c++-0.5.3
  pre:
    - sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang 100
    - sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++ 100
    - sudo apt-get install clang-3.3
    - curl -O https://capnproto.org/capnproto-c++-0.5.3.tar.gz
    - tar zxf capnproto-c++-0.5.3.tar.gz
    - (cd capnproto-c++-0.5.3 && ./configure && make check && sudo make install)
    - mkdir -p ~/local/lib/python2.7/site-packages
    - (cd nta.utils && python setup.py develop --prefix=/home/ubuntu/local)
    - (cd htmengine && python setup.py develop --prefix=/home/ubuntu/local)
    - (cd infrastructure && python setup.py develop --prefix=/home/ubuntu/local)
    - (cd taurus.metric_collectors && python setup.py develop --prefix=/home/ubuntu/local)
    - pip install `cat taurus/requirements.txt | grep uwsgi` --user
    - (cd taurus && python setup.py develop --prefix=/home/ubuntu/local)
    - sudo apt-get install nginx
  post:
    - mkdir -p logs
    - taurus-set-rabbitmq --host=${RABBITMQ_HOST} --user=${RABBITMQ_USER} --password=${RABBITMQ_PASSWD}
    - taurus-set-sql-login --host=${MYSQL_HOST} --user=${MYSQL_USER} --password=
    - taurus-create-db --host=${MYSQL_HOST} --user=${MYSQL_USER} --password= --suppress-prompt-and-continue-with-deletion
    - (cd /home/ubuntu/numenta-apps/taurus/taurus/engine/repository && python migrate.py)
    - (cd /home/ubuntu/numenta-apps/taurus/pipeline/circleci && ./generate-ssl-cert.sh)
    - cp -r taurus/pipeline/circleci/overrides/taurus/* taurus/conf/
test:
  pre:
    - sudo nginx -p taurus -c conf/nginx-taurus.conf
  override:
    - py.test nta.utils/tests/unit
    - py.test htmengine/tests/unit
    - py.test taurus/tests/unit
